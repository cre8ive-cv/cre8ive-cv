<!DOCTYPE html>
<html lang="en">
<script>
(function() {
  try {
    const savedMode = localStorage.getItem('mode') || 'dark';
    document.documentElement.setAttribute('data-mode', savedMode);
  } catch (e) {
    document.documentElement.setAttribute('data-mode', 'dark');
  }

  const loader = document.createElement('div');
  loader.id = 'mode-loader';
  loader.innerHTML = '<div class="loader-bar"></div>';
  document.documentElement.appendChild(loader);
})();
</script>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template Preview | cre8ive.cv</title>
  <meta name="description" content="Preview and customize your resume template">
  <link rel="icon" type="image/png" href="/assets/logo-rocket-circle.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/variables.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    :root[data-mode="hacker"] body {
      background:
        radial-gradient(circle at 20% 50%, rgba(123, 228, 149, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(82, 201, 122, 0.06) 0%, transparent 50%),
        linear-gradient(135deg, #040806 0%, #060b08 50%, #0a120d 100%);
      background-attachment: fixed;
    }

    .template-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .template-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 80px;
      flex-wrap: wrap;
      gap: 20px;
      position: relative;
      min-height: 60px;
    }

    .template-action-wrapper {
      position: absolute;
      right: 0;
      top: 2px;
      display: none;
      flex-direction: row;
      align-items: stretch;
      gap: 12px;
      max-width: 50%;
    }

    .template-action-wrapper.visible {
      display: flex;
    }

    .template-header .template-action-wrapper {
      margin-bottom: 0;
    }

    .template-header .use-template-btn {
      margin-left: auto;
    }

    .template-warning-header {
      margin-bottom: 32px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      background: rgba(255, 235, 59, 0.15);
      border: 1px solid rgba(255, 235, 59, 0.4);
      border-radius: 8px;
      padding: 10px 16px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      flex: 1;
      box-sizing: border-box;
    }

    .template-warning-header i {
      color: #ffeb3b;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .template-warning-header strong {
      color: var(--text-primary);
    }

    .template-buttons-container {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-end;
      gap: 12px;
      flex-shrink: 0;
    }

    .template-buttons-container button {
      white-space: nowrap;
    }

    .cancel-template-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .cancel-template-btn:hover {
      background: var(--bg-medium);
      transform: translateY(-2px);
    }

    .cancel-template-btn:active {
      transform: translateY(0);
    }

    .template-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-hover));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 8px;
      background: rgba(100, 181, 246, 0.1);
      transition: all 0.3s ease;
    }

    .back-link:hover {
      background: rgba(100, 181, 246, 0.2);
      transform: translateX(-4px);
    }


    .template-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 40px;
    }

    @media (max-width: 1024px) {
      .template-content {
        grid-template-columns: 1fr;
      }
    }

    .content-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 80vh;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    #pdfViewerContainer {
      flex: 1;
      min-height: 0;
      display: flex;
    }

    .pdf-viewer {
      width: 100%;
      height: 100%;
      max-height: 100%;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: white;
    }

    /* Mobile PDF viewer styles */
    .pdf-preview-mobile-viewer {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      max-height: 100%;
      background: var(--bg-darkest);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      .content-section {
        height: 72vh;
      }
      .pdf-viewer,
      .pdf-preview-mobile-viewer,
      .json-viewer {
        height: 100%;
        max-height: 100%;
      }
    }

    .pdf-preview-canvas-container {
      flex: 1;
      overflow: auto;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      background: var(--bg-darkest);
    }

    .pdf-preview-canvas {
      max-width: 100%;
      height: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }

    .pdf-preview-mobile-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .pdf-nav-btn {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-medium);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .pdf-nav-btn:hover:not(:disabled) {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
      transform: translateY(-2px);
    }

    .pdf-nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pdf-page-info {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
      min-width: 80px;
      text-align: center;
    }

    .pdf-current-page {
      color: var(--accent-primary);
      font-weight: 600;
    }

    .pdf-preview-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      color: var(--text-secondary);
      gap: 16px;
    }

    .pdf-download-fallback-btn {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .pdf-download-fallback-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .json-viewer {
      background: var(--bg-darkest);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      height: 100%;
      max-height: 100%;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--text-secondary);
      cursor: not-allowed;
      user-select: text;
      position: relative;
    }

    .json-viewer::before {
      content: 'Read-only preview';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-medium);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .json-viewer pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .json-string { color: #98c379; }
    .json-number { color: #d19a66; }
    .json-boolean { color: #c678dd; }
    .json-null { color: #e06c75; }
    .json-key { color: #61afef; }

    :root[data-mode="light"] .json-string { color: #50a14f; }
    :root[data-mode="light"] .json-number { color: #986801; }
    :root[data-mode="light"] .json-boolean { color: #a626a4; }
    :root[data-mode="light"] .json-null { color: #e45649; }
    :root[data-mode="light"] .json-key { color: #4078f2; }

    :root[data-mode="hacker"] .json-string { color: #7be495; }
    :root[data-mode="hacker"] .json-number { color: #9bf2b2; }
    :root[data-mode="hacker"] .json-boolean { color: #52c97a; }
    :root[data-mode="hacker"] .json-null { color: #74d88d; }
    :root[data-mode="hacker"] .json-key { color: #a9d6b9; }

    .use-template-btn {
      background: var(--green);
      color: #1a1a1a;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 230, 118, 0.3);
      white-space: nowrap;
    }

    .use-template-btn:hover {
      background: var(--green-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 230, 118, 0.4);
    }

    .use-template-btn:active {
      transform: translateY(0);
    }

    .use-template-btn.warning-state {
      background: #ffd700;
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }

    .use-template-btn.warning-state:hover {
      background: #ffed4e;
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 16px;
      display: block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .error-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--error);
    }

    .error-message i {
      font-size: 3rem;
      margin-bottom: 20px;
      display: block;
    }

    @media (max-width: 1024px) {
      .template-header {
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 40px;
      }

      .template-action-wrapper {
        position: relative;
        right: auto;
        top: auto;
        max-width: 100%;
        width: 100%;
        margin-top: 20px;
      }

      .template-header .use-template-btn {
        margin-left: 0;
        width: 100%;
      }

      .template-title {
        font-size: 2rem;
      }
    }

    @media (max-width: 768px) {
      .template-action-wrapper {
        flex-direction: column;
      }

      .template-warning-header {
        margin-bottom: 0;
      }

      .template-buttons-container {
        width: 100%;
        align-items: stretch;
      }

      .template-buttons-container button {
        width: 100%;
      }

      .template-title {
        font-size: 1.75rem;
      }

      .back-link {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="template-container">
    <div class="template-header">
      <a href="/gallery" class="back-link">
        <i class="fas fa-arrow-left"></i>
        Back to Gallery
      </a>
      <h1 class="template-title" id="templateTitle"></h1>
      <button class="use-template-btn" id="useTemplateBtn">
        <i class="fas fa-rocket"></i> Use this template
      </button>
      <div class="template-action-wrapper">
        <div class="template-warning-header">
          <span>
            <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong> Using this template will replace current state of your changes in the main editor. Make sure to export it to JSON first!
            <br><br>
            Go back to the <a href="/" style="color: var(--accent-primary); text-decoration: underline;">main page</a>
          </span>
        </div>
        <div class="template-buttons-container">
          <button class="cancel-template-btn" id="cancelTemplateBtn">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button class="use-template-btn warning-state" id="confirmTemplateBtn">
            <i class="fas fa-check"></i> Confirm using this template
          </button>
        </div>
      </div>
    </div>

    <div id="templateContent">
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <div>Loading template...</div>
      </div>
    </div>
  </div>

  <script>
    // Detect if user is on mobile device
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
    }

    // Render PDF using PDF.js for mobile devices
    async function renderMobilePdfPreview(pdfUrl, container) {
      const mobileViewer = document.createElement('div');
      mobileViewer.className = 'pdf-preview-mobile-viewer';

      // Create canvas container
      const canvasContainer = document.createElement('div');
      canvasContainer.className = 'pdf-preview-canvas-container';

      const canvas = document.createElement('canvas');
      canvas.className = 'pdf-preview-canvas';
      canvasContainer.appendChild(canvas);

      // Create navigation controls
      const controls = document.createElement('div');
      controls.className = 'pdf-preview-mobile-controls';
      controls.innerHTML = `
        <button class="pdf-nav-btn pdf-prev-btn" disabled>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <span class="pdf-page-info">
          <span class="pdf-current-page">1</span> / <span class="pdf-total-pages">1</span>
        </span>
        <button class="pdf-nav-btn pdf-next-btn" disabled>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M8 4L14 10L8 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      `;

      mobileViewer.appendChild(canvasContainer);
      mobileViewer.appendChild(controls);
      container.appendChild(mobileViewer);

      try {
        // Fetch PDF file
        const response = await fetch(pdfUrl);
        const blob = await response.blob();
        const arrayBuffer = await blob.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let currentPage = 1;
        const totalPages = pdf.numPages;

        // Update total pages
        controls.querySelector('.pdf-total-pages').textContent = totalPages;

        // Function to render a specific page
        async function renderPage(pageNum) {
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1 });

          // Calculate scale to fit width of container
          const containerWidth = canvasContainer.clientWidth;
          const scale = (containerWidth - 40) / viewport.width; // 40px for padding

          // Render at device pixel ratio to keep the preview sharp without changing zoom
          const outputScale = window.devicePixelRatio || 1;
          const scaledViewport = page.getViewport({ scale });

          canvas.width = Math.floor(scaledViewport.width * outputScale);
          canvas.height = Math.floor(scaledViewport.height * outputScale);
          canvas.style.width = `${Math.floor(scaledViewport.width)}px`;
          canvas.style.height = `${Math.floor(scaledViewport.height)}px`;

          const renderContext = {
            canvasContext: canvas.getContext('2d'),
            viewport: scaledViewport,
            transform: outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : undefined
          };

          await page.render(renderContext).promise;

          // Update current page display
          controls.querySelector('.pdf-current-page').textContent = pageNum;

          // Update button states
          const prevBtn = controls.querySelector('.pdf-prev-btn');
          const nextBtn = controls.querySelector('.pdf-next-btn');
          prevBtn.disabled = pageNum === 1;
          nextBtn.disabled = pageNum === totalPages;
        }

        // Render first page
        await renderPage(1);

        // Add navigation event listeners
        controls.querySelector('.pdf-prev-btn').addEventListener('click', async () => {
          if (currentPage > 1) {
            currentPage--;
            await renderPage(currentPage);
          }
        });

        controls.querySelector('.pdf-next-btn').addEventListener('click', async () => {
          if (currentPage < totalPages) {
            currentPage++;
            await renderPage(currentPage);
          }
        });

      } catch (error) {
        console.error('Error rendering PDF with PDF.js:', error);
        mobileViewer.innerHTML = `
          <div class="pdf-preview-error">
            <p>Failed to render PDF preview</p>
            <a href="${pdfUrl}" target="_blank" class="pdf-download-fallback-btn">Open PDF</a>
          </div>
        `;
      }
    }

    // JSON syntax highlighting
    function syntaxHighlight(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    // Load template
    async function loadTemplate() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('id');

        if (!templateId) {
          throw new Error('No template ID provided');
        }

        const response = await fetch('/api/gallery/templates');
        const templates = await response.json();
        const template = templates.find(t => t.id === templateId);

        if (!template) {
          throw new Error('Template not found');
        }

        document.getElementById('templateTitle').textContent = template.label;
        document.title = `${template.label} | cre8ive.cv`;

        // Load JSON data
        const jsonResponse = await fetch(`/gallery/${template.folder}/${template.json}`);
        const jsonData = await jsonResponse.json();

        const content = document.getElementById('templateContent');
        const pdfPath = `/gallery/${template.folder}/${template.pdf}`;

        content.innerHTML = `
          <div class="template-content">
            <div class="content-section">
              <h2 class="section-title">
                <i class="fas fa-file-pdf"></i>
                PDF Preview
              </h2>
              <div id="pdfViewerContainer"></div>
            </div>
            <div class="content-section">
              <h2 class="section-title">
                <i class="fas fa-code"></i>
                JSON Data
              </h2>
              <div class="json-viewer">
                <pre>${syntaxHighlight(JSON.stringify(jsonData, null, 2))}</pre>
              </div>
            </div>
          </div>
        `;

        // Render PDF based on device type
        const pdfContainer = document.getElementById('pdfViewerContainer');
        if (isMobileDevice()) {
          // Mobile: Use PDF.js canvas rendering
          renderMobilePdfPreview(pdfPath, pdfContainer);
        } else {
          // Desktop: Use iframe
          const iframe = document.createElement('iframe');
          iframe.className = 'pdf-viewer';
          iframe.src = pdfPath;
          iframe.title = 'PDF Preview';
          iframe.setAttribute('aria-label', 'PDF Preview');
          pdfContainer.appendChild(iframe);
        }

        // Attach event listener to the button with two-step confirmation
        const headerButton = document.getElementById('useTemplateBtn');
        const actionWrapper = document.querySelector('.template-action-wrapper');
        const cancelBtn = document.getElementById('cancelTemplateBtn');
        const confirmBtn = document.getElementById('confirmTemplateBtn');

        headerButton.addEventListener('click', () => {
          // Show action wrapper, hide header button
          actionWrapper.classList.add('visible');
          headerButton.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
          // Hide action wrapper, show header button
          actionWrapper.classList.remove('visible');
          headerButton.style.display = 'block';
        });

        confirmBtn.addEventListener('click', () => {
          // Execute action
          useTemplate(jsonData);
        });

      } catch (error) {
        console.error('Error loading template:', error);
        document.getElementById('templateContent').innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h2>Failed to load template</h2>
            <p>${error.message}</p>
            <a href="/gallery" class="back-link" style="margin-top: 20px;">
              <i class="fas fa-arrow-left"></i>
              Back to Gallery
            </a>
          </div>
        `;
      }
    }

    function useTemplate(jsonData) {
      try {
        // Store the template JSON in localStorage
        localStorage.setItem('resumeData', JSON.stringify(jsonData));

        // Redirect to main editor
        window.location.href = '/';
      } catch (error) {
        alert('Failed to load template. Please try again.');
        console.error('Error using template:', error);
      }
    }

    loadTemplate();

    // Remove loader after page loads
    window.addEventListener('load', () => {
      const loader = document.getElementById('mode-loader');
      if (loader) {
        loader.remove();
      }
    });
  </script>
</body>
</html>
